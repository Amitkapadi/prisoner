(function(){!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof module&&module.exports?module.exports=b():a.prisoner=b()}(this,function(){var a,b,c,d;return b=function(){function a(a,b){if(this.begin=a,this.end=b,this.horizontal=this.begin.y===this.end.y,this.begin.x>this.end.x||this.begin.y>this.end.y||this.begin.x===this.end.x&&this.begin.y===this.end.y)throw new Error("Piece coordinates aren't valid.")}return a}(),a=function(){function c(a){var b,c,d,e,f,g,h,i;for(this.width=a.width,this.height=a.height,d=a.prisoner,this.matrix=[],i=b=0,e=this.width;e>=0?e>b:b>e;i=e>=0?++b:--b){for(g=[],h=c=0,f=this.height;f>=0?f>c:c>f;h=f>=0?++c:--c)g.push(0);this.matrix.push(g)}this.pieces=[],this.addPiece(d)}return c.prototype.addPiece=function(a){var b,c,d,e,f,g,h;for(this.pieces.push(a),b=this.pieces.length,f=[],g=c=d=a.begin.x,e=a.end.x+1;e>=d?e>c:c>e;g=e>=d?++c:--c)f.push(function(){var c,d,e,f;for(f=[],h=c=d=a.begin.y,e=a.end.y+1;e>=d?e>c:c>e;h=e>=d?++c:--c)f.push(this.matrix[h][g]=b);return f}.call(this));return f},c.prototype.move=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L;if(null==c&&(c=1),q=this.pieces[a],f=a+1,e=[],q.horizontal)if(b){if(!(q.end.x+c<this.width))return!1;for(g=h=t=q.end.x+1,u=q.end.x+c;u>=t?u>=h:h>=u;g=u>=t?++h:--h)e.push({x:g,y:q.begin.y})}else{if(!(q.begin.x-c>=0))return!1;for(g=i=B=q.begin.x-1,C=q.begin.x-c;C>=B?C>=i:i>=C;g=C>=B?++i:--i)e.push({x:g,y:q.begin.y})}else if(b){if(!(q.end.y+c<this.height))return!1;for(g=k=D=q.end.y+1,E=q.end.y+c;E>=D?E>=k:k>=E;g=E>=D?++k:--k)e.push({x:q.begin.x,y:g})}else{if(!(q.begin.y-c>=0))return!1;for(g=l=F=q.begin.y-1,G=q.begin.y-c;G>=F?G>=l:l>=G;g=G>=F?++l:--l)e.push({x:q.begin.x,y:g})}for(o=0,j=e.length;j>o;o++)if(d=e[o],0!==this.matrix[d.y][d.x])return!1;for(K=p=H=q.begin.x,I=q.end.x+1;I>=H?I>p:p>I;K=I>=H?++p:--p)for(L=r=v=q.begin.y,w=q.end.y+1;w>=v?w>r:r>w;L=w>=v?++r:--r)this.matrix[L][K]=0;for(m={x:q.begin.x,y:q.begin.y},n={x:q.end.x,y:q.end.y},q.horizontal?b?(m.x+=c,n.x+=c):(m.x-=c,n.x-=c):b?(m.y+=c,n.y+=c):(m.y-=c,n.y-=c),q.begin=m,q.end=n,K=s=x=q.begin.x,y=q.end.x+1;y>=x?y>s:s>y;K=y>=x?++s:--s)for(L=J=z=q.begin.y,A=q.end.y+1;A>=z?A>J:J>A;L=A>=z?++J:--J)this.matrix[L][K]=f;return!0},c.prototype.canExit=function(){var a,b,c,d,e,f,g,h,i;if(c=this.pieces[0],c.horizontal){for(h=a=d=c.end.x+1,e=this.width;e>=d?e>a:a>e;h=e>=d?++a:--a)if(0!==this.matrix[c.end.y][h])return!1}else for(i=b=f=c.end.y+1,g=this.height;g>=f?g>b:b>g;i=g>=f?++b:--b)if(0!==this.matrix[i][c.end.x])return!1;return!0},c.prototype.clone=function(){var c,d,e,f;for(c=new a({width:this.width,height:this.height,prisoner:new b({x:this.pieces[0].begin.x,y:this.pieces[0].begin.y},{x:this.pieces[0].end.x,y:this.pieces[0].end.y})}),d=e=1,f=this.pieces.length;f>=1?f>e:e>f;d=f>=1?++e:--e)c.addPiece(new b({x:this.pieces[d].begin.x,y:this.pieces[d].begin.y},{x:this.pieces[d].end.x,y:this.pieces[d].end.y}));return c},c}(),c=function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(h=c.length,s=c[0].length,d=[],u=j=0,o=h;o>=0?o>j:j>o;u=o>=0?++j:--j)for(t=k=0,p=s;p>=0?p>k:k>p;t=p>=0?++k:--k)d[c[u][t]]||(d[c[u][t]]=[]),d[c[u][t]].push({x:t,y:u});for(n=[],i=l=1,q=d.length;q>=1?q>l:l>q;i=q>=1?++l:--l)e=d[i][0],f=d[i][d[i].length-1],n.push(new b(e,f));for(g=new a({width:s,height:h,prisoner:n[0]}),i=m=1,r=n.length;r>=1?r>m:m>r;i=r>=1?++m:--m)g.addPiece(n[i]);return g},d=function(a){var b,c,d,e,f,g,h,i;if(b=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(b=[],l=[a];l.length;){if(c=l.shift(),c.canExit())return c;if(f=JSON.stringify(c.matrix),-1===b.indexOf(f))for(b.push(f),d=g=0,m=c.pieces.length;m>=0?m>g:g>m;d=m>=0?++g:--g){for(e=h=1;4>=h;e=++h)k=c.clone(),k.move(d,!0,e)&&(k.parent=c,k.diff={piece:d,direction:!0,steps:e},l.push(k));for(e=i=1;4>=i;e=++i)j=c.clone(),j.move(d,!1,e)&&(j.parent=c,j.diff={piece:d,direction:!1,steps:e},l.push(j))}}return!1},g=b(a)){for(i=[],i.push(g),f=g.parent;f;)i.push(f),f=f.parent;for(i.pop(),i=i.reverse(),c=[],d=0,e=i.length;e>d;d++)h=i[d],c.push(h.diff),delete h.diff,delete h.parent;return{diffs:c,steps:i,solution:g}}return!1},{Piece:b,Game:a,arrayToGame:c,solve:d}})}).call(this);